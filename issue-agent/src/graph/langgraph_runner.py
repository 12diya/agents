from langgraph.graph import StateGraph, END
from github import Github
import os
from typing import TypedDict, Optional, List, Any

from src.agents.reviewer_agent import get_reviewer_agent
from IPython.display import Image, display


class AgentState(TypedDict):
    input: str
    review_result: Optional[Any]
    decision: Optional[bool]
    issues_to_create: Optional[List[dict]]
    generation_result: Optional[Any]


def reviewer_node(llm, tools):
    agent = get_reviewer_agent(llm, tools)

    def run(state: AgentState) -> AgentState:
        print("🧠 Reviewer agent thinking...")
        result = agent.invoke({"input": state["input"]})

        create_issues = False
        issues = []

        if isinstance(result, dict):
            create_issues = result.get("create_issues", False)
            issues = result.get("ISSUES", [])

        return {
            **state,
            "review_result": result,
            "decision": create_issues,
            "issues_to_create": issues,
        }

    return run


def generator_node():

    def run(state: AgentState) -> AgentState:
        print("⚙️ Generator creating issues...")
        gh = Github(os.environ["GITHUB_TOKEN"])
        repo = gh.get_repo(os.environ["GITHUB_REPO"])
        results = []

        for issue in state.get("issues_to_create", []):
            title = issue.get("title", "")
            body = f"{issue.get('body', '')}\n\n---\n_Generated by issue-agent_"
            created = repo.create_issue(title=title, body=body, labels=["issue-agent"])
            results.append(created.html_url)

        return {**state, "generation_result": results}
    return run


def should_create_issues(state: AgentState) -> str:
    return "create" if state.get("decision") else "end"


def build_multi_agent_issue_graph(llm, tools):
    graph = StateGraph(AgentState)

    graph.add_node("reviewer", reviewer_node(llm, tools))
    graph.add_node("generator", generator_node())

    graph.set_entry_point("reviewer")
    graph.add_conditional_edges("reviewer", should_create_issues, {
        "create": "generator",
        "end": END,
    })
    graph.add_edge("generator", END)

    # display(Image(graph.get_graph().draw_mermaid_png()))
    return graph.compile()
